<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <title>Test</title>
  <script type="text/javascript" src="../jsunit/app/jsUnitCore.js"></script>
  <script type="text/javascript" src="TestSupport.js"></script>
  <script type="text/javascript" src="JsMock.js"></script>
  <script type="text/javascript" src="../src/JspScript.js"></script>
  <script type="text/javascript" src="../src/Generator.js"></script>
</head>
<body>

<script type="text/javascript">

  var env;
  var spyScribe;
  var generator;
  var out;

  function setUp() {
    env = new JspScript.Env();
    generator = new JspScript.Generator(env);

    spyScribe = new JspScript.Scribe();
    out = '';
    spyScribe.oldPut = spyScribe.put;
    spyScribe.put = function(str) {
      out += str; spyScribe.oldPut(str);
    }
  }

  function testSimpleDomGeneration_Generator() {
    var dom = env.createDomFromString(
        '<html><body><h2 id="header">Hello World!</h2>More text...\n</body></html>');

    var spyScribe = new JsMock(JspScript.Scribe, function() {
      JsMock.expect('prolog');
      JsMock.expect('element', 'html', [], true);
      JsMock.expect('element', 'body', [], true);
      JsMock.expect('element', 'h2', [{name: 'id', value: '\'header\''}], true);
      JsMock.expect('text', 'Hello World!');
      JsMock.expect('pop');
      JsMock.expect('text', 'More text...\n');
      JsMock.expect('pop');
      JsMock.expect('pop');
      JsMock.expect('epilog');
    });

    generator.generateFunctionBody(dom.childNodes, spyScribe);

    JsMock.validate(spyScribe);
  }

  function testSimpleDomGeneration_Scribe() {
    // <html><body><h2 id="header">Hello World!</h2>More text...\n</body></html>

    spyScribe.prolog();
    spyScribe.element('html', [], true);
    spyScribe.element('body', [], true);

    out = '';
    spyScribe.element('h2', [{name: 'id', value: '\'header\''}], true);
    assertEquals("q('h2','id','header');\n", out);

    spyScribe.text('Hello World!');
    spyScribe.pop();
    spyScribe.text('More text...\n');
    spyScribe.pop();
    spyScribe.pop();
    spyScribe.epilog();

    var script = spyScribe.getScript();
    console.log(script);
    var fn = new Function('attrs', script)
    var rendered = fn({});

    assertNodes(['<HTML>'], rendered);
    var html = rendered[0];
    assertChildren(['<BODY>'], html);
    var body = html.childNodes[0];
    assertChildren(['<H2>', 'More text...\n'], body);
    var h2 = body.childNodes[0];
    assertEquals('header', h2.getAttribute('id'));
  }

  function testTaglibTagBody_Generator() {
    var dom = env.createDomFromString(
        '<%@ taglib prefix="x" uri="http://xxx/xxx" %><x:test>contents</x:test>');

    var spyScribe = new JsMock(JspScript.Scribe, function() {
      JsMock.expect('prolog');
      JsMock.expect('taglibDeclaration', 'x', 'http://xxx/xxx');
      JsMock.expect('tagStart', 'x', 'test', [], generator);
      JsMock.expect('text', 'contents');
      JsMock.expect('tagEnd');
      JsMock.expect('epilog');
    });

    generator.generateFunctionBody(dom.childNodes, spyScribe);

    JsMock.validate(spyScribe);
  }

  function testTaglibTagBody_Scribe() {
//  '<%@ taglib prefix="x" uri="http://xxx/xxx" %><x:test>contents</x:test>'
    env.registerTaglib('http://xxx/xxx', {
      test: env.createTemplateFromString('@<jsp:doBody/>@')
    });

    spyScribe.prolog();
    spyScribe.taglibDeclaration('x', 'http://xxx/xxx');
    out = '';
    spyScribe.tagStart('x', 'test', [], generator);
    spyScribe.text('contents');
    spyScribe.tagEnd();
    spyScribe.epilog();

    var script = spyScribe.getScript();
    console.log(script);
    var fn = new Function('attrs', script)
    var template = new JspScript.Template(fn, env);
    assertText('@contents@', template.render({}));
  }

  function testJspDoBodyCall_Generator() {
    var dom = env.createDomFromString(
        '<jsp:doBody/>');

    var spyScribe = new JsMock(JspScript.Scribe, function() {
      JsMock.expect('prolog');
      JsMock.expect('tagStart', 'jsp', 'doBody', [], generator);
      JsMock.expect('tagEnd');
      JsMock.expect('epilog');
    });

    generator.generateFunctionBody(dom.childNodes, spyScribe);

    JsMock.validate(spyScribe);
  }

  function testJspDoBodyCall_Scribe() {
//        '<jsp:doBody/>'

    spyScribe.prolog();

    out = '';
    spyScribe.tagStart('jsp', 'doBody', [], generator);
    spyScribe.tagEnd();

    assertEquals(
        "e(tagContext.renderBody(null, attrs));\n", out);

    spyScribe.epilog();

    var script = spyScribe.getScript();
    var fn = new Function('attrs', 'tagContext', script);
    var template = new JspScript.Template(fn, env);

    var bodyFnCalled = false;
    var bodyFunction = function(g, tagContext) {
      bodyFnCalled = true;
      assertEquals('outerValue', g('outer'));
      assertEquals('innerValue', g('inner'));
      assertEquals('from inner', g('override'));
      return [document.createTextNode("value from bodyFunction")];
    };
    var tagContext = new JspScript.TagContext(null, bodyFunction, {outer: 'outerValue', override: 'from outer'});
    assertText("value from bodyFunction",
        template.renderTag_({inner: 'innerValue', override: 'from inner'}, null, tagContext));
    assertTrue(bodyFnCalled);
  }

  function testJspIncludeCall_Scribe() {
//        '<jsp:doBody/>'

    spyScribe.prolog();

    out = '';
    spyScribe.tagStart('jsp', 'include', [{name: 'page', value: '\'xxx\''}], generator);
    spyScribe.tagEnd();

    assertEquals(
        "this.env_.render({page:'xxx'}.page, attrs, parent);\n", out);

    spyScribe.epilog();

    var script = spyScribe.getScript();
    var fn = new Function('attrs', 'tagContext', script);
    var template = new JspScript.Template(fn, env);

    var renderFnCalled = false;
    env.render = function(uri, attrs, parent) {
      renderFnCalled = true;
      assertEquals('xxx', uri);
      assertHashEquals({the:'hash'}, attrs);
      parent.appendChild(document.createTextNode("value from include"));
    };
    console.log("testJspDoBodyCall_Scribe", fn.toString());
    assertText('value from include', template.render({the:'hash'}));
    assertTrue(renderFnCalled);
  }

  function testTaglibTagBodyCanAccessBothTagAndOuterAttributes_Generator() {
    var dom = env.createDomFromString(
        '<%@ taglib prefix="x" uri="http://xxx/xxx" %>' +
        'attr from outside ${value}, <x:test tagValue="also">inside a tag body it ${value} ${tagValue}!</x:test>');

    var spyScribe = new JsMock(JspScript.Scribe, function() {
      JsMock.expect('prolog');
      JsMock.expect('taglibDeclaration', 'x', 'http://xxx/xxx');
      JsMock.expect('text', 'attr from outside ');
      JsMock.expect('expression', 'g(\'value\')');
      JsMock.expect('text', ', ');
      JsMock.expect('tagStart', 'x', 'test', [{name: 'tagValue', value: '\'also\''}], generator);
      JsMock.expect('text', 'inside a tag body it ');
      JsMock.expect('expression', 'g(\'value\')');
      JsMock.expect('text', ' ');
      JsMock.expect('expression', 'g(\'tagValue\')');
      JsMock.expect('text', '!');
      JsMock.expect('tagEnd');
      JsMock.expect('epilog');
    });

    generator.generateFunctionBody(dom.childNodes, spyScribe);

    JsMock.validate(spyScribe);
  }

  function testTaglibTagBodyCanAccessBothTagAndOuterAttributes_Scribe() {
//        '<%@ taglib prefix="x" uri="http://xxx/xxx" %>' +
//        'attr from outside ${value}, <x:test tagValue="also">inside a tag body it ${value} ${tagValue}!</x:test>');

    env.registerTaglib('http://xxx/xxx', {
      test: env.createTemplateFromString('<jsp:doBody/>')
    });

    spyScribe.prolog();
    spyScribe.taglibDeclaration('x', 'http://xxx/xxx');
    spyScribe.text('attr from outside ');
    spyScribe.expression('g(\'value\')');
    spyScribe.text(', ');

    out = '';
    spyScribe.tagStart('x', 'test', [{name: 'tagValue', value: '\'also\''}], generator);
    spyScribe.text('inside a tag body it ');
    spyScribe.expression('g(\'value\')');
    spyScribe.text(' ');
    spyScribe.expression('g(\'tagValue\')');
    spyScribe.text('!');
    spyScribe.tagEnd();

    assertEquals(
        "n('x','test', {tagValue:'also'}, function(g, tagContext) {\n" +
        "w('inside a tag body it ');\n" +
        "x(g('value'));\n" +
        "w(' ');\n" +
        "x(g('tagValue'));\n" +
        "w('!');\n" +
        "return top;\n" +
        "}, attrs);\n", out);
//    assertEquals(
//        "this.doTag_('x','test', {tagValue:'also'}, parent,\n" +
//        "new JspScript.TagContext(this, function(g, tagContext) {" +
//        "w('inside a tag body it ');" +
//        "x(g('value'));" +
//        "w(' ');" +
//        "x(g('tagValue'));" +
//        "w('!');" +
//        "}, attrs));", out);

    spyScribe.epilog();

    var script = spyScribe.getScript();
    console.log(script);
    var fn = new Function('attrs', script);
    var template = new JspScript.Template(fn, env);

    assertNodes(['attr from outside ', 'works', ', ', 'inside a tag body it ', 'works', ' ', 'also', '!'],
        template.render({value: 'works'}));
  }

  function testTaglibTagAttributesOverrideOuterAttributes() {
    var template = env.createTemplateFromString(
        '<%@ taglib prefix="x" uri="http://xxx/xxx" %>' +
        'attr from outside ${value}, <x:test value="can be overridden">inside a tag body it ${value}</x:test>');
    env.registerTaglib('http://xxx/xxx', {
      test: env.createTemplateFromString('<jsp:doBody/>')
    });

//    assertNodes(['attr from outside works, ', 'inside a tag body it can be overridden'], template.render({value: 'works'}));
    assertNodes(['attr from outside ', 'works', ', ', 'inside a tag body it ', 'can be overridden'],
        template.render({value: 'works'}));
  }

  function testJavaStringsAreConvertedToJsStringsForRhino() {
    var JavaString = function(text) {
      this._text = text;
    }

    JavaString.prototype.toString = function() {
      return this._text;
    }

    JavaString.prototype.replace = function() {
      throw new Error("should have been converted to JS string!");
    }

    var nodes = [
      { nodeType: Node.ELEMENT_NODE, tagName: new JavaString("tag"),
        attributes: [
          { name: new JavaString('name'), value: new JavaString('value'), other: new JavaString('foof') }
        ],
        childNodes: [
          { nodeType: Node.TEXT_NODE, nodeValue: new JavaString("text") }
        ]
      }
    ];
    nodes[0].attributes.item = function(i) { return this[i]; }
    nodes[0].childNodes.item = function(i) { return this[i]; }

    nodes.item = function(i) { return this[i]; }
    var template = env.createTemplateFromDom({childNodes: nodes});
    assertText('[DOM: <tag name="value">text</tag>]', template.render({}));
  }

  function testArrayIteratorsUseItemsMethodNotArrayIndexesForRhino() {
    var DomItems = function(items) {
      console.log('new DomItems', items);
      this._items = items;
      this.length = items.length;
    }

    DomItems.prototype.item = function(i) {
      return this._items[i];
    }

    var nodes = new DomItems([
      { nodeType: Node.ELEMENT_NODE, tagName: "tag",
        attributes: new DomItems([
          { name: 'name', value: 'value' }
        ]),
        childNodes: new DomItems([
          { nodeType: Node.TEXT_NODE, nodeValue: "text" }
        ])
      }
    ]);

    var template = env.createTemplateFromDom({childNodes: nodes});
    assertText('[DOM: <tag name="value">text</tag>]', template.render({}));
  }

</script>

</body>
</html>